AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  Data preprocessing

  SAM Template for data preprocessing

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Tracing: Active
  Api:
    TracingEnabled: True

Parameters:
  ExecutionRoleArn:
    Type: String
    Description: the arn of execution role for a SageMaker Pipeline
    MinLength: 10
  AssetBucket:
    Type: String
    Description: S3 bucket for asset "f548316fae2347f1029ea86b62ade2cd8c53555d7a8e235b4812f0912ea273b0"
  AssetKey:
    Type: String
    Description: S3 key for asset version "f548316fae2347f1029ea86b62ade2cd8c53555d7a8e235b4812f0912ea273b0"

Resources:
  StockTradingStateMachine:
    Type: AWS::Serverless::StateMachine # More info about State Machine Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-statemachine.html
    Properties:
      DefinitionUri: statemachine/datapreprocessing.asl.json
      DefinitionSubstitutions:
        StartGlueJobTaskFunctionArn: !GetAtt StartGlueJobTask.Arn
        DDBPutItem: !Sub arn:${AWS::Partition}:states:::dynamodb:putItem
        DDBTable: !Ref TransactionTable
      Events:
        HourlyTradingSchedule:
          Type: Schedule # More info about Schedule Event Source: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-statemachine-schedule.html
          Properties:
            Description: Schedule to run the stock trading state machine every hour
            Enabled: False # This schedule is disabled by default to avoid incurring charges.
            Schedule: "rate(1 hour)"
      Policies: # Find out more about SAM policy templates: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-policy-templates.html
        - LambdaInvokePolicy:
            FunctionName: !Ref StartGlueJobTask
        - DynamoDBWritePolicy:
            TableName: !Ref TransactionTable

  StartGlueJobTask1:
    Type: AWS::Serverless::Function # More info about Function Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Properties:
      CodeUri: functions/start_glue/
      Handler: app.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
  
  StartGlueJobTask:
    Type: AWS::Glue::Job # More info about Function Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html
    Properties:
      Command:
        Name: glueetl
        PythonVersion: "3"
        ScriptLocation:
          Fn::Join:
            - ""
            - - s3://
              - Ref: AssetBucket
              - /
              - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: AssetParametersf548316fae2347f1029ea86b62ade2cd8c53555d7a8e235b4812f0912ea273b0S3VersionKey3582CA93
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: AssetParametersf548316fae2347f1029ea86b62ade2cd8c53555d7a8e235b4812f0912ea273b0S3VersionKey3582CA93
      Role:
        Fn::GetAtt:
          - Role1ABCC5F0
          - Arn
      DefaultArguments:
        --job-language: python
        --job-bookmark-option: job-bookmark-enable
        --enable-metrics: ""
        --additional-python-modules: pyarrow==2,awswrangler==2.9.0,fsspec==0.7.4
      Description: Prepare data for SageMaker training
      ExecutionProperty:
        MaxConcurrentRuns: 1
      GlueVersion: "2.0"
      Name: sagemaker-pipeline-GlueJob
      NumberOfWorkers: 10
      Timeout: 60
      WorkerType: Standard
    Metadata:
      aws:cdk:path: CfnStack/sagemaker-pipeline-GlueJob/Resource

  TransactionTable:
    Type: AWS::Serverless::SimpleTable # More info about SimpleTable Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-simpletable.html
    Properties:
      PrimaryKey:
        Name: Id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

Outputs:
  # StockTradingStateMachineHourlyTradingSchedule is an implicit Schedule event rule created out of Events key under Serverless::StateMachine
  # Find out more about other implicit resources you can reference within SAM
  # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-generated-resources.html
  StockTradingStateMachineArn:
    Description: "Stock Trading State machine ARN"
    Value: !Ref StockTradingStateMachine
  StockTradingStateMachineRoleArn:
    Description: "IAM Role created for Stock Trading State machine based on the specified SAM Policy Templates"
    Value: !GetAtt StockTradingStateMachineRole.Arn
